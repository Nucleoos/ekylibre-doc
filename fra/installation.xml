<?xml version="1.0" encoding="UTF-8"?>
<!-- Dernière modification
le $Date$
par $Author$
révision $Revision$ -->

<chapter id="installation">
  <title>Procédures d'installation</title>

  <indexterm zone="installation">
    <primary>installation</primary>
  </indexterm>

  <para>Ce chapitre décrit l'installation d'&ekylibre; en utilisant le code source. (Ce <phrase>chapitre</phrase> peut être ignoré lors de l'installation d'une distribution pré-empaquetée, paquet RPM ou Debian, par exemple. Il est alors plus utile de lire les instruction du mainteneur du paquet.)</para>

  <para>&ekylibre; utilise <ulink url="http://www.ruby-lang.org">Ruby</ulink> et le framework <ulink url="http://rubyonrails.org/">Ruby on Rails</ulink>. Vous pouvez le télécharger librement sur <ulink url="http://www.ekylibre.org">www.ekylibre.org</ulink>. &ekylibre; fonctionne avec les bases de données <ulink url="http://mysql.com">MySQL</ulink>, <ulink url="http://www.postgresql.org">PostgreSQL</ulink> et <ulink url="http://sqlite.org">SQLite</ulink> (il n'a pas été testé avec d'autres bases de données).
  </para>

  <sect1 id="classic-debian-installation">
    <title>Installation classique sous les systèmes d'exploitation basés sur Debian</title>
    <para>L'installation d'&ekylibre; sous les <ulink url="http://www.debian.org/misc/children-distros.fr.html">distribution dérivées</ulink> de Debian peut se faire automatiquement avec un gestionnaire de paquet si les dépendances sont satisfaites (Ce qui est le cas à partir de Squeeze (6) sous Debian et de Maverick (10.10) sous Ubuntu)</para>
    <para>Sinon, il est toujours possible de l'installer manuellement.</para>
    <para>Les paquets &ekylibre; sont disponibles sur <ulink url="http://www.ekylibre.org">www.ekylibre.org</ulink>. Après téléchargement du paquet, il faut l'installer avec Gdebi qui installera aussi les dépendances.</para>    
  </sect1>




  <sect1 id="manual-debian-installation">
    <title>Installation <emphasis>manuelle</emphasis> sous les systèmes d'exploitation basés sur Debian</title>

    <sect2>
      <title>Mise en place de l'environnement</title>

      <sect3>
	<title>Récupération d'&ekylibre;</title>

	<para>Vous pouvez récupérer une archive des sources d'&ekylibre; sur <ulink url="http://www.ekylibre.org">www.ekylibre.org</ulink>. Une fois le fichier récupéré, vous pouvez le décompresser et vous positionner dedans.</para>
	<screen>wget https://www.ekylibre.org/releases/latest/source/ekylibre-0.3.0-source.tar.bz2
tar xjvf ekylibre-0.3.0-source.tar.bz2
cd ekylibre/</screen>
<para>ou directement sur <ulink url="https://www.github.com/ekylibre/ekylibre">Github</ulink>&nbsp;:</para>
<screen>wget https://www.github.com/ekylibre/ekylibre/tarball/master
tar xzvf ekylibre-0.3.x-gyyyyyyy.tar.gz
cd ekylibre-ekylibre-yyyyyyy</screen>
      </sect3>



      <sect3>
	<title>Installation de la base de données</title>

	<para>Maintenant, il faut installer et/ou configurer la base de données. &ekylibre; respecte au maximum les standards SQL communs à PostgreSQL, MySQL et SQLite. En théorie, il est compatible avec tous les adaptateurs fournis avec Ruby On Rails (Oracle, Firebird, Microsoft SQLServer...) mais n'a jamais été réellement testé. La première phase de l'installation est donc de s'assurer que vous avez une base de données en route. Si c'est déjà la cas, vous pouvez passer cette étape.</para>
	<itemizedlist>
	  <listitem>
	    <para>Pour PostgreSQL, il suffit d'installer le paquet par défaut. &ekylibre; est compatible avec les versions 8.3 et supérieures&nbsp;:</para>
	    <screen>sudo apt-get install postgresql libpq-dev</screen>
	  </listitem>
	  <listitem>
	    <para>Pour MySQL, le paquet par défaut convient, s'il n'en existe pas il faut installer un paquet <package>mysql-server-5.x</package>. &ekylibre; est compatible avec les versions 5 et supérieures&nbsp;:</para>
	    <screen>sudo apt-get install mysql-server libmysqlclient-dev</screen>
	  </listitem>
	  <listitem>
	    <para>Pour SQLite3, il suffit juste d'installer la librairie de développement&nbsp;:</para>
	    <screen>sudo apt-get install libsqlite3-dev</screen>
	  </listitem>
	</itemizedlist>
      </sect3>
      

      <sect3>
	<title>Installation de Ruby</title>
	<para>&ekylibre; fonctionne avec la version 1.8.7 ou 1.9.2 de Ruby. C'est le premier composant à installer&nbsp;:
	<screen>sudo apt-get install ruby</screen>
	</para>
	<para>Si vous disposez par défaut d'une version antérieure, il va être nécessaire d'installer Ruby manuellement depuis les sources. Les commandes suivantes permettent de télécharger le code source, le décompresser, le compiler et installer ruby 1.9.2&nbsp;:
	<screen>wget http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.2-p290.tar.bz2
tar xjvf ruby-1.9.2-p290.tar.bz2
cd ruby-1.9.2-p290
./configure
make
sudo make install</screen>
	Pour plus de détails, voir <ulink url="http://www.ruby-lang.org/fr/">le site officiel de Ruby</ulink>.</para>
      </sect3>


      <sect3>
	<title>Installation de Rubygems</title>
	<para><ulink url="http://www.rubygems.org">Rubygems</ulink> est un gestionnaire de paquets pour les scripts Ruby. Il est indépendant des circuits de validation des paquets du système Debian. Il est utilisable à partir de la version 1.3.7&nbsp;:
	<screen>sudo apt-get install rubygems</screen>
	</para>
	<para>Si la version est trop ancienne, vous pouvez l'installer manuellement&nbsp;:
	<screen>wget http://production.cf.rubygems.org/rubygems/rubygems-1.8.10.tgz
tar xzvf rubygems-1.8.10.tgz
cd rubygems-1.8.10
sudo ruby setup.rb</screen>
<note><para>Si la commande <command>gem</command> est indisponible, il est probable que la commande <command>gem1.8</command> ou <command>gem1.9</command> ne le soit pas. Si c'est le cas il est recommandé de faire un lien symbolique pour la commande <command>gem</command> soit disponible.</para></note>
	</para>
      </sect3>


      <sect3>
	<title>Installation de Rake</title>
	<para>Rake est un utilitaire similaire à Make mais en Ruby nécessaire à la maintenance d'&ekylibre;&nbsp;:</para>
	<screen>sudo apt-get install rake</screen>
	<para>Si le paquet n'existe pas dans votre distribution, vous pouvez passer par Rubygems pour installer ce composant&nbsp;:</para>
	<screen>sudo gem install rake</screen>
	<note>
	  <para>Si après cette commande la commande <command>rake</command> ne réponds pas, il faut rajouter un lien symbolique dans le dossier des commandes <filename>/usr/bin</filename>&nbsp;:</para>
	  <screen>cd /usr/bin
sudo ln -s `gem environment gemdir`/bin/rake</screen>
	</note>
      </sect3>

      
      <sect3>
	<title>Installation de <package>Bundler</package> et des gems</title>
	<para>&ekylibre; utilise Bundler pour gérer les gems dont il dépend&nbsp;:
	<screen>sudo gem install bundler</screen>
	</para>
	<para>Certaines gems sont compilées à l'installation, pour cela, il faut installer les paquets de développement au préalable si ce n'est pas déjà le cas&nbsp;:</para>
	<screen>sudo apt-get install build-essential ruby-dev libxml2-dev libpq-dev zlib1g-dev</screen>
	<para>Si vous comptez utiliser une base de données SQLite, alors il faut installer la librairie de développement de SQLite</para>
	<screen>sudo apt-get install libsqlite3-dev</screen>
	<para>Maintenant, il est possible de lancer bundler pour installer toutes les gems. Pour cela&nbsp;:</para>
	<screen>bundle install</screen>
      </sect3>
      

      <sect3>
	<title>Configuration de la base de données</title>

	<para>Maintenant, il faut installer la structure de la base de données. Pour cela, il faut mettre en place le fichier <filename>./config/database.yml</filename> pour définir les connexions aux bases de données à utiliser. Pour cela, vous trouverez trois fichiers <filename>database.mysql.yml</filename>, <filename>database.postgresql.yml</filename> et <filename>database.sqlite3.yml</filename> qui peuvent servir de base pour créer votre fichier <filename>database.yml</filename>.</para>
	<para>Vous pouvez copier le fichier qui correspond à votre base de données en <filename>database.yml</filename>. Puis éditez-le pour compléter les champs correspondants comme dans les exemples ci-dessous&nbsp;:</para>

	<note>
	  <para>&ekylibre; comme toutes les applications Ruby on Rails peut tourner dans différents modes basiques qui sont&nbsp;: development, test et production. À chaque mode correspond une utilisation de l'application&nbsp;:</para>
	  <itemizedlist>
	    <listitem><para>le mode <emphasis>development</emphasis> est utilisé par les développeurs. Il est plus lent que les autres car il n'utilise pratiquement pas de cache.</para></listitem>
	    <listitem><para>le mode <emphasis>test</emphasis> est utilisé par les développeurs pour lancer des batteries de tests dans un environnement similaire à celui de production.</para></listitem>
	    <listitem><para>le mode <emphasis>production</emphasis> est utilisé pour installer et faire tourner l'application en fonctionnement normal.</para></listitem>
	  </itemizedlist>
	  <para>Le reste de la documentation part du principe que l'on souhaite installer &ekylibre; en mode production. Pour basculer de mode, il suffit de remplacer <emphasis>"production"</emphasis> par le mode que vous souhaitez utiliser dans le reste de la documentation.</para>
	</note>

	<itemizedlist>

	  <listitem>
	    <para>Exemple de configuration avec PostgreSQL pour la base en mode développement&nbsp;:</para>
<programlisting>
# ./config/database.yml
production:
  adapter: postgresql
  encoding: unicode
  database: ekylibre_production
  pool: 5
  username: ekylibre
  password: Mon_Mot-D3_p45Se!
  host: 127.0.0.1
</programlisting>
<para>Il faut créer manuellement l'utilisateur et la base de données sous PostgreSQL si cela n'a pas déjà été fait. Cela peut se faire soit par une interface déjà en place (phppgadmin, pgadmin3...) soit directement en ligne de commande avec <command>psql</command>&nbsp;:</para>
<screen>
ekylibre$ sudo su postgres
postgres$ psql
psql (8.4.8)
Saisissez « help » pour l'aide.

postgres=# CREATE USER ekylibre CREATEDB WITH ENCRYPTED PASSWORD 'Mon_Mot-D3_p45Se!';
CREATE ROLE
postgres=# CREATE DATABASE ekylibre_production;
CREATE DATABASE
</screen>
	  </listitem>


	  <listitem>
	    <para>Exemple de configuration pour une base SQLite3&nbsp;:</para>
<programlisting>
# ./config/database.yml
production:
  adapter: sqlite3
  database: db/production.sqlite3
  pool: 5
  timeout: 5000
</programlisting>
	  </listitem>

	  <listitem>
	    <para>Exemple de configuration pour une base de production MySQL</para>
<programlisting>
# ./config/database.yml
production:
  adapter: mysql
  database: ekylibre_production
  pool: 5
  username: ekylibre
  password: Mon_Mot-D3_p45Se!
</programlisting>
	  <para>Comme pour PostgreSQL, il faut créer au préalable l'utilisateur et la base de données tels que spécifiés dans le fichier <filename>config/database.yml</filename>&nbsp;:</para>
	  <screen>CREATE USER ekylibre IDENTIFIED BY 'Mon_Mot-D3_p45Se!';
CREATE DATABASE IF NOT EXISTS ekylibre_production;
GRANT ALL ON ekylibre_production.* TO 'ekylibre'@'localhost';</screen>
	  </listitem>
	</itemizedlist>
      </sect3>


      <sect3>
	<title>Construction des tables en base de données</title>
	<para>Une fois cette configuration effectuée, il faut lancer la migration pour préparer ou mettre à jour la base de données&nbsp;:</para>
	<screen>rake db:migrate RAILS_ENV=production</screen>
	<para>Pour installer la base de données d'autres environnements, il vous suffit de relancer la commande avec le nom de l'environnement souhaité&nbsp;:</para>
	<screen>rake db:migrate RAILS_ENV=development</screen>
      </sect3>

    </sect2>



    <sect2>
      <title>Lancement du serveur</title>

      <sect3>
	<title>En mode développement</title>
	<para>Pour lancer votre serveur en mode développement, il suffit d'éxecuter la commande à la racine de votre dossier&nbsp;:</para>
	<screen>rails s</screen>
	<para>Pour que tout fonctionne correctement, il faut avoir configurer correctement l'environnement <emphasis>development</emphasis> au départ.</para>
      </sect3>


      <sect3>
	<title>En mode production avec Passenger</title>
	<para>Pour faire tourner &ekylibre; dans des conditions convenables, il est nécessaire de passer en mode production avec Apache2 et Passenger.</para>
	<screen>sudo apt-get install apache2 apache2-prefork-dev build-essential</screen>
	<para>Une fois Apache installé, il faut installer le module passenger qui est une gem à compiler</para>
	<screen>gem install passenger</screen>
	<para>Il faut éxecuter la commande d'installation qui compilera un module pour Apache2&nbsp;:</para>
	<screen>passenger-install-apache2-module</screen>
	<para>Si la commande ne répond pas, il faut utiliser la commande ci-dessous&nbsp;:</para>
	<screen>`gem environment gemdir`/bin/passenger-install-apache2-module</screen>
	<para>La compilation peut prendre quelques minutes.</para>
	<para>Ensuite, il faut ajouter le module à Apache&nbsp;:</para>
	<screen>passenger-install-apache2-module --snippet > /etc/apache2/conf.d/passenger.conf</screen>
	<para>ou si nécessaire&nbsp;:</para>
	<screen>`gem environment gemdir`/bin/passenger-install-apache2-module --snippet > /etc/apache2/conf.d/passenger.conf</screen>
	<para>Maintenant que Apache peut utiliser Passenger, il faut configurer l'application &ekylibre;. Pour cela il faut créer un fichier de configuration <filename>/etc/apache2/sites-available/ekylibre</filename> qui définiera l'hôte qui hébergera l'application&nbsp;:</para>
<programlisting><![CDATA[
RailsAutoDetect Off
RailsBaseURI /ekylibre
<Directory /chemin/vers/ekylibre>
        Options FollowSymLinks -MultiViews
        Allow from all
        PassengerAppRoot /chemin/vers/ekylibre
</Directory>
]]></programlisting>
        <para>Ce fichier de configuration n'est pas encore "activé", pour que Apache le prenne en compte, il faut l'activer en utilisant la commande <command>a2ensite</command>&nbsp;:</para>
	<screen>sudo a2ensite ekylibre</screen>
        <para>Enfin, pour valider les changement sous Apache, il faudra le recharger avec sa nouvelle configuration&nbsp;:</para>
	<screen>sudo invoke-rc.d apache2 reload</screen>
        <para>Ekylibre sera accessible avec votre navigateur à l'URL <uri>http://localhost/ekylibre</uri></para>
      </sect3>
    </sect2>
  </sect1>


  <sect1 id="windows-installation">
    <title>Installation sous <productname>Microsoft Windows</productname></title>

    <sect2>
      <title>Installation automatique</title>
      <para>
	Les étapes de l'installation sont les suivantes :
	<itemizedlist>
	  <listitem><para>
	    Lancer l'exécutable <filename>ekylibre-x.y.z.exe</filename> que vous avez téléchargé.
	  </para></listitem>
	  <listitem><para>
	    Suivre les indications en cliquant sur <guibutton>Suivant</guibutton>. Vers la fin de l'installation, un terminal apparait où la migration s'effectue. Cette opération peut prendre du temps.
	  </para></listitem>
	  <listitem><para>
	    Pour utiliser &ekylibre;, il suffit d'aller dans le menu : <guimenu>Démarrer</guimenu> &gt; <guisubmenu>Tous les programmes</guisubmenu> &gt; <guisubmenu>&ekylibre;</guisubmenu> &gt; <guimenuitem>&ekylibre; X.Y.Z</guimenuitem>. Il ouvre votre navigateur par défaut sur la page d'accueil d'&ekylibre;.
	  </para></listitem>
	</itemizedlist>
      </para>    

      <para>
	À la première utilisation, il n'y a pas de comptes utilisateurs définis donc vous devez vous enregistrer vous-même en suivant la procédure suivante&nbsp;:
	<orderedlist>
	  <listitem><para>Cliquez sur <guibutton>Créer une société</guibutton></para></listitem>
	  <listitem><para>Une fois la page chargée, saisissez les informations concernant votre société et vous-même et validez.</para></listitem>
	</orderedlist>
	Après un temps de chargement, vous accéderez à la page d'accueil d'&ekylibre; de votre société.
      </para>

      <important><para>Lors de l'enregistrement, n'oubliez pas de noter votre nom d'utilisateur ainsi que votre mot de passe.</para></important>
    </sect2>    

    <sect2>
      <title>Installation manuelle</title>

      <para>L'installation pas après pas sous Windows n'est pas disponible car inutile. L'installateur remplit toutes les fonctions nécessaires sur les différentes versions de Windows.</para>
    </sect2>




  </sect1>

</chapter>